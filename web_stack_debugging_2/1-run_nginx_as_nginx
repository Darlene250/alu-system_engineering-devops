#!/usr/bin/env bash
# Configures Nginx to listen on port 8080 and run as the 'nginx' user

# 1. Stop Apache (Port 8080 conflict)
service apache2 stop > /dev/null 2>&1 || true
pkill -9 apache2 > /dev/null 2>&1 || true

# 2. Configure Port 8080
sed -i 's/listen 80 default_server;/listen 8080 default_server;/g' /etc/nginx/sites-available/default
sed -i 's/listen \[::\]:80 default_server;/listen \[::\]:8080 default_server;/g' /etc/nginx/sites-available/default

# 3. Configure User 'nginx' (The "Nuclear" Fix)
# First, add the user just in case it is missing
adduser --system --no-create-home --shell /bin/false --group --disabled-login nginx > /dev/null 2>&1 || true

# Delete ANY line that contains the word "user" and ends with ";" to clear old configs
sed -i '/user .*;/d' /etc/nginx/nginx.conf

# Insert the correct config at the very top of the file
sed -i '1iuser nginx;' /etc/nginx/nginx.conf

# 4. Restart Nginx
service nginx restart
